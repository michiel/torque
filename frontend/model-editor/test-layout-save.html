<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Layout Save</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .console {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            min-height: 200px;
            overflow-y: auto;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        .step.completed {
            background-color: #d4edda;
            color: #155724;
        }
        .step.failed {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Layout Save Test</h1>
        <p>This page tests the Visual Layout Editor saving functionality after the entity ID conversion fix.</p>
        
        <div class="step">
            <h3>Step 1: Open Model Editor</h3>
            <button class="button" onclick="openModelEditor()">Open Model Editor</button>
            <span id="step1-status">Pending</span>
        </div>
        
        <div class="step">
            <h3>Step 2: Test Entity ID Conversion</h3>
            <button class="button" onclick="testEntityConversion()">Test Entity ID Conversion</button>
            <span id="step2-status">Pending</span>
        </div>
        
        <div class="step">
            <h3>Step 3: Simulate Save Process</h3>
            <button class="button" onclick="simulateSave()">Simulate Save Process</button>
            <span id="step3-status">Pending</span>
        </div>
        
        <div class="console" id="console"></div>
        
        <div>
            <h3>Test Results:</h3>
            <ul id="results"></ul>
        </div>
    </div>

    <script>
        let console_output = '';
        const consoleDiv = document.getElementById('console');
        const resultsUl = document.getElementById('results');
        
        function log(message) {
            console.log(message);
            console_output += new Date().toISOString() + ': ' + message + '\n';
            consoleDiv.textContent = console_output;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        function updateStep(stepId, status, message) {
            const stepElement = document.getElementById(stepId + '-status');
            stepElement.textContent = status;
            stepElement.parentElement.className = 'step ' + (status === 'Completed' ? 'completed' : status === 'Failed' ? 'failed' : '');
            
            if (message) {
                const li = document.createElement('li');
                li.textContent = message;
                resultsUl.appendChild(li);
            }
        }
        
        function openModelEditor() {
            log('Opening Model Editor...');
            window.open('http://localhost:3001/', '_blank');
            updateStep('step1', 'Completed', 'Model Editor opened in new tab');
        }
        
        function testEntityConversion() {
            log('Testing entity ID conversion logic...');
            
            // Mock available entities
            const availableEntities = [
                { id: 'uuid-customer-123', name: 'customer', displayName: 'Customer' },
                { id: 'uuid-order-456', name: 'order', displayName: 'Order' },
                { id: 'uuid-product-789', name: 'product', displayName: 'Product' }
            ];
            
            // Mock Puck data with entity references
            const puckData = {
                content: [
                    {
                        type: 'DataGrid',
                        props: {
                            entityType: 'customer',
                            columns: [
                                { field: 'name', header: 'Name' },
                                { field: 'email', header: 'Email' }
                            ]
                        }
                    },
                    {
                        type: 'TorqueForm',
                        props: {
                            entityType: 'order',
                            fields: [
                                { name: 'amount', label: 'Amount' },
                                { name: 'status', label: 'Status' }
                            ]
                        }
                    }
                ],
                root: {
                    title: 'Test Layout'
                }
            };
            
            // Mock the conversion function (simplified version)
            function convertPuckToLegacyLayout(puckData, layoutId, modelId, existingLayout, availableEntities) {
                const components = puckData.content.map((item, index) => ({
                    componentType: item.type,
                    position: {
                        row: index,
                        column: 0,
                        width: 12,
                        height: item.type === 'DataGrid' ? 6 : item.type === 'TorqueForm' ? 8 : 2
                    },
                    properties: {
                        ...item.props,
                        _puckData: JSON.stringify(item),
                        _visualEditor: true
                    },
                    styling: {}
                }));
                
                // Extract target entities
                const targetEntityNames = [...new Set(
                    components
                        .filter(comp => comp.properties && 'entityType' in comp.properties && comp.properties.entityType)
                        .map(comp => comp.properties.entityType)
                        .filter(Boolean)
                )];
                
                log('Converting entity names to IDs:');
                log('Target entity names: ' + JSON.stringify(targetEntityNames));
                log('Available entities: ' + JSON.stringify(availableEntities.map(e => ({ id: e.id, name: e.name }))));
                
                const targetEntities = targetEntityNames
                    .map(entityName => {
                        const entity = availableEntities.find(e => e.name === entityName);
                        if (!entity) {
                            log(`WARNING: Entity with name "${entityName}" not found in available entities`);
                            return null;
                        }
                        log(`Mapped entity "${entityName}" to ID: ${entity.id}`);
                        return entity.id;
                    })
                    .filter(Boolean);
                
                return {
                    name: puckData.root?.title || 'New Layout',
                    modelId,
                    targetEntities,
                    components,
                    layoutType: 'Dashboard',
                    responsive: {
                        breakpoints: [
                            { name: 'mobile', minWidth: 0, columns: 1 },
                            { name: 'tablet', minWidth: 768, columns: 2 },
                            { name: 'desktop', minWidth: 1024, columns: 3 }
                        ]
                    }
                };
            }
            
            const result = convertPuckToLegacyLayout(puckData, 'test-layout', 'test-model', null, availableEntities);
            
            log('Conversion result:');
            log(JSON.stringify(result, null, 2));
            
            // Check if conversion was successful
            if (result.targetEntities && result.targetEntities.length === 2) {
                updateStep('step2', 'Completed', 'Entity ID conversion successful: ' + result.targetEntities.join(', '));
            } else {
                updateStep('step2', 'Failed', 'Entity ID conversion failed');
            }
        }
        
        function simulateSave() {
            log('Simulating save process...');
            
            // Check if the Model Editor is accessible
            fetch('http://localhost:3001/')
                .then(response => {
                    if (response.ok) {
                        log('Model Editor is accessible');
                        updateStep('step3', 'Completed', 'Save simulation successful - Model Editor is running and accessible');
                    } else {
                        log('Model Editor responded with error: ' + response.status);
                        updateStep('step3', 'Failed', 'Model Editor not accessible');
                    }
                })
                .catch(error => {
                    log('Error accessing Model Editor: ' + error.message);
                    updateStep('step3', 'Failed', 'Cannot access Model Editor at localhost:3001');
                });
        }
        
        // Initialize
        log('Layout Save Test initialized');
        log('Ready to test the Visual Layout Editor saving functionality');
    </script>
</body>
</html>